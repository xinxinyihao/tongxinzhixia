# 同心之匣 - 天涯若比邻

## 项目简介

同心之匣是一个基于WebSocket的多人同步视频播放系统，允许多个用户同时观看同一视频，并实时同步播放状态。无论用户身处何地，都能享受到共同观影的乐趣，实现"天涯若比邻"的观影体验。

## 核心功能

- **实时同步播放**：所有用户的视频播放、暂停、进度跳转都能实时同步
- **视频管理**：添加、删除视频，支持在线视频URL
- **播放状态保存**：自动保存最后的播放位置和状态
- **多设备支持**：适配PC和移动设备，响应式设计
- **连接状态监控**：显示网络延迟和连接状态
- **实时通知系统**：用户加入、离开等事件的实时通知
- **磨砂玻璃UI**：现代化、美观的用户界面

## 技术栈

- **前端**：原生JavaScript、CSS3、ArtPlayer视频播放器
- **后端**：Node.js、Express、WebSocket
- **通信**：WebSocket实时双向通信
- **数据存储**：JSON配置文件

## 系统架构

### 前端

- **播放器组件**：基于ArtPlayer实现，支持各种播放控制
- **视频列表**：显示可播放的视频，支持添加和删除
- **通知区域**：显示系统消息和用户活动
- **状态指示器**：显示连接状态和网络延迟
- **响应式布局**：适配不同屏幕尺寸

### 后端

- **WebSocket服务器**：处理客户端连接和消息传递
- **API接口**：提供视频管理功能
- **状态管理**：维护当前播放状态
- **配置保存**：自动保存系统状态到配置文件

## 使用方法

### 安装

```bash
# 克隆项目
git clone <https://github.com/xinxinyihao/tongxinzhixia.git>

# 安装依赖
npm install
```

### 运行

```bash
# 启动服务器
npm start
```

服务器启动后，将显示HTTP和WebSocket服务的访问地址。

### 访问

- 在浏览器中打开显示的HTTP地址（如`http://localhost:8833`）
- 多个用户访问同一地址，即可实现同步观影

## 特色功能详解

### 实时同步机制

- 基于WebSocket的实时通信
- 自动处理网络延迟补偿
- 播放状态的定期同步更新

### 自适应连接策略

- 自动检测访问方式（域名/IP）
- 端口模式和路径模式双重支持
- 断线自动重连机制

### 多设备兼容

- 移动设备的特殊处理
- 自动播放限制的解决方案
- 触摸交互优化

### 用户体验优化

- 磨砂玻璃效果的现代UI
- 弹窗通知系统
- 网络状态实时监控

## 配置说明

服务器配置文件`config.json`包含以下配置项：

```json
{
  "server": {
    "port": 8833,
    "enableNotifications": true,
    "autoPlayNext": true,
    "networkDelayThreshold": 600
  },
  "videos": [
    {
      "name": "视频名称",
      "url": "视频URL",
      "id": "唯一ID"
    }
  ],
  "currentVideo": {
    "id": "当前播放视频ID",
    "position": 0,
    "playing": false
  }
}
```

## 系统原理

### 播放同步流程

1. 第一个用户打开页面，自动加载配置文件中的上次播放状态
2. 新用户加入时，接收当前正在播放的实时状态
3. 任何用户的播放操作都通过WebSocket广播给所有其他用户
4. 所有用户离开时，自动保存最后的播放状态

### 状态保存机制

- 定期自动保存（每10分钟）
- 所有用户离开时保存
- 用户手动关闭页面时保存当前播放位置

## 部署指南

### 本地部署

适用于局域网内多设备同步观看。

### 服务器部署

1. 确保服务器开放对应端口（默认8833）
2. 推荐使用反向代理（如Nginx）进行域名访问
3. 如使用HTTPS，WebSocket也会自动升级为安全连接

## 开发者指南

### 消息类型

系统支持多种消息类型用于同步：
- `play`: 播放视频
- `pause`: 暂停视频
- `seek`: 跳转到指定位置
- `changeVideo`: 切换视频
- `syncState`: 同步播放状态
- `notification`: 系统通知
- 等等...

### 代码结构

- `server/server.js`: 后端服务器代码
- `public/js/main.js`: 前端主要代码
- `public/css/style.css`: 界面样式
- `public/index.html`: 网页结构

## 贡献者

- [项目作者]

---

同心之匣，天涯若比邻 